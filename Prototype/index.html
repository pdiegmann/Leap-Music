<html>
<head>
    <title>Leap Music</title>
    <link href="css/style.css" rel="stylesheet">

	<script src="js/leap.js"></script>
	<script src="js/timbre.js"></script>
</head>
<body>
<div id="content">
    <br>
	<div id="output"></div>
	<br><canvas id="plot" style="width:240px;height:80px" width="240" height="80"></canvas>     
</div>
<div id="button">
<br>
	<button id="toggleButton" onclick="javascript:toggle();">pause</button>
	<br><img src="images/logo.jpg">
</div>
	
	<script>
		var emulateLeapMotion = true; // true = mouse | false = leap motion
		var isPlaying = true;
		var tone = undefined;
		var reverb = undefined;
		var master = undefined;
		var phaser = undefined;
		var paddingPercentage = 0.15; // padding which surrounds the 'sensitive area'
		var toggleButton = document.getElementById('toggleButton'); // html-dom-element for play/pause
		var output = document.getElementById('output'); // html-dom-element for debug-output
		var minVolume = -53;
		var maxVolume = 12;
		//var maxFrequency = 493.88; // B4
		//var minFrequency = 65.41; // C2
		var centerFrequency = 261.63; //(maxFrequency + minFrequency) / 2;

		(function() {
			tone = T("sin", {freq: centerFrequency}) // the default 'center' tone
			var freq = T("sin", {freq:0.0001, add:2400, mul:800}).kr();
  			phaser = T("phaser", {freq:freq, Q:1, steps:8}, tone)
			reverb = T("reverb", {room:0.4, mix:0.35}, phaser);
			master = T("eq", {}, reverb).play();
			tone = tone.set({buddies:master});
			var defaultFrequency = tone.freq.value; // the default tone's frequency
			//pause();

			if (emulateLeapMotion == true) {
			    function handleMouseMove(event) {
			        event = event || window.event; // IE-ism
			        processPositionChange([event.clientX, window.innerHeight-event.clientY, 0], window.innerHeight, window.innerWidth);
			    }
		   		window.onmousemove = handleMouseMove;
			}
			else {
				Leap.loop(function (frame) {
					if (frame != undefined) {
						var hands = frame.hands;
						var interactionBox = frame.interactionBox;
						if (interactionBox != undefined && hands != undefined && hands.length > 0) {
							var hand = hands[0];
							if (hand != undefined) {
								var position = hand.palmPosition;
								var height = interactionBox.height;
								var width = interactionBox.width;
								processPositionChange(position, height, width);
							}
						}
					}
				});
			}

			function processPositionChange(position, roomHeight, roomWidth) {
				var y = position[1]; // 0: x, 1: y, 2: z
				var x = position[0];

				y = Math.max(y, roomHeight * paddingPercentage); // => 10% of height means the 10 lowest % of room are 'ignored'
				y = Math.min(y, roomHeight * (1 - paddingPercentage)); // => 10% of height means the 10 heighest % of room are 'ignored'

				y = y - (roomHeight * paddingPercentage); // move everything 10% down
				y = y / (1 - (paddingPercentage * 2)); // stretch the room to reach 1 by dividing by 0.8
				y = y / roomHeight; // normalize to [0..1] by dividing by max value (room's height)

				y = y + 0.5; // add 0.5 to have y in [0.5, 1.5] to multiply with the 'default' tone and have a range between the 'half' and 'oneandahalf' tone

				roomWidth = roomWidth / 2; // highest volume is in the room's center
				if (x > roomWidth) {
					x = roomWidth - (x - roomWidth); // calculate the offset from the center and 'mirror' it into the opposite direction
				}

				x = Math.max(x, roomWidth * paddingPercentage);
				x = Math.min(x, roomWidth * (1 - paddingPercentage));

				x = x - (roomWidth * paddingPercentage);
				x = x / (1 - (paddingPercentage * 2));
				x = x / roomWidth;

				x = x * (maxVolume + (minVolume * -1));
				x = x - (minVolume * -1);

				//console.log("x, y, z: " + position[0] + ", " + position[1] + ", " + position[2] + " normalized y: " + y + " height: " + roomHeight + " freq: " + defaultFrequency + " -> " + defaultFrequency * y);
				if (output != undefined) {
					output.innerHTML = "x: " + position[0] + "<br/>y: " + position[1] + "<br/>z: " + position[2] + "<br/>normalized y: " + y + "<br/>height: " + roomHeight + "<br/>old frequency: " + tone.freq.value + "<br/>new frequency: " + defaultFrequency * y + "<br/>normalized x: " + x;
				}

				tone.freq.value = defaultFrequency * y;

				//master.setParams(5, 1, 0, x);

				master.plot({target:plot, lineWidth:2});
			}
	  	})();

		function pause() {
			tone.pause();
			isPlaying = false;
			toggleButton.innerHTML = "play";
		}
		function play() {
			tone.play();
			isPlaying = true;
			toggleButton.innerHTML = "pause";
		}
		function toggle() {
			isPlaying ? pause() : play();
		}
	</script>
</body>